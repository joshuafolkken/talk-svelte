name: Deploy to VPS

on:
  repository_dispatch:
    types: [new-tag-created]
  # push:
  #   branches: [main]
  # workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: 'vps-deploy'
  cancel-in-progress: true

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: NODE_ENV=production npm run build

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            build \
            package.json \
            package-lock.json \
            node_modules \
            .env.example

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy.tar.gz
          retention-days: 1

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_SSH_PORT }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            cd /var/www/talk-svelte
            
            # バックアップ作成
            if [ -d "build" ]; then
              cp -r build build.backup.$(date +%Y%m%d_%H%M%S) || true
            fi
            
            # デプロイパッケージを転送
          ENDSSH

          scp -i ~/.ssh/deploy_key -P $VPS_SSH_PORT deploy.tar.gz $VPS_USER@$VPS_HOST:/var/www/talk-svelte/

          ssh -i ~/.ssh/deploy_key -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            cd /var/www/talk-svelte
            
            # 既存のファイルをバックアップ
            if [ -d "build" ]; then
              mv build build.backup.$(date +%Y%m%d_%H%M%S) || true
            fi
            
            # デプロイパッケージを展開
            tar -xzf deploy.tar.gz
            
            # 依存関係をインストール（productionのみ）
            npm ci --production
            
            # PM2でアプリケーションを再起動
            pm2 restart talk-svelte || pm2 start ecosystem.config.js
            
            # 古いバックアップを削除（5つまで保持）
            ls -t build.backup.* 2>/dev/null | tail -n +6 | xargs rm -rf || true
            
            # デプロイパッケージを削除
            rm -f deploy.tar.gz
            
            echo "✅ Deployment completed successfully"
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f deploy.tar.gz
