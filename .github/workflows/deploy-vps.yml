name: Deploy to VPS

on:
  repository_dispatch:
    types: [new-tag-created]
  # push:
  #   branches: [main]
  # workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: 'vps-deploy'
  cancel-in-progress: true

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: NODE_ENV=production npm run build

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            build \
            package.json \
            package-lock.json \
            node_modules \
            .env.example

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy.tar.gz
          retention-days: 1

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH鍵を書き込み（改行を保持）
          echo "$VPS_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # known_hostsを設定
          ssh-keyscan -p $VPS_SSH_PORT $VPS_HOST >> ~/.ssh/known_hosts 2>/dev/null
          chmod 644 ~/.ssh/known_hosts

          # SSH鍵の形式を確認（デバッグ用）
          echo "SSH key fingerprint:"
          ssh-keygen -lf ~/.ssh/deploy_key 2>/dev/null || echo "Failed to read SSH key"

          # 公開鍵を抽出（デバッグ用）
          echo "Extracted public key:"
          ssh-keygen -y -f ~/.ssh/deploy_key 2>/dev/null || echo "Failed to extract public key"

          # SSH鍵の最初と最後の数行を表示（機密情報を隠すため）
          echo "SSH key file (first 3 lines):"
          head -n 3 ~/.ssh/deploy_key || true
          echo "SSH key file (last 3 lines):"
          tail -n 3 ~/.ssh/deploy_key || true

      - name: Test SSH connection
        run: |
          echo "Attempting SSH connection to $VPS_USER@$VPS_HOST:$VPS_SSH_PORT"
          echo "Using SSH key: ~/.ssh/deploy_key"

          # Verboseモードで接続を試みる（最初の試行）
          ssh -v -i ~/.ssh/deploy_key \
            -p $VPS_SSH_PORT \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            $VPS_USER@$VPS_HOST \
            "echo 'SSH connection successful'" 2>&1 || {
              echo "SSH connection failed. Please check:"
              echo "1. Server's ~/.ssh/authorized_keys contains the public key"
              echo "2. SSH key permissions are correct (600)"
              echo "3. Public key extracted above matches the one in authorized_keys"
              exit 1
            }

      - name: Deploy to server
        run: |
          # デプロイパッケージを転送
          scp -i ~/.ssh/deploy_key \
            -P $VPS_SSH_PORT \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            deploy.tar.gz \
            $VPS_USER@$VPS_HOST:/var/www/talk-svelte/

          # サーバー側でデプロイ処理を実行
          ssh -i ~/.ssh/deploy_key \
            -p $VPS_SSH_PORT \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o BatchMode=yes \
            $VPS_USER@$VPS_HOST \
            'bash -s' << 'ENDSSH'
              set -e
              cd /var/www/talk-svelte
              
              # 既存のファイルをバックアップ
              if [ -d "build" ]; then
                mv build build.backup.$(date +%Y%m%d_%H%M%S) || true
              fi
              
              # デプロイパッケージを展開
              tar -xzf deploy.tar.gz
              
              # 依存関係をインストール（productionのみ）
              npm ci --production
              
              # PM2でアプリケーションを再起動
              pm2 restart talk-svelte || pm2 start ecosystem.config.js
              
              # 古いバックアップを削除（5つまで保持）
              ls -t build.backup.* 2>/dev/null | tail -n +6 | xargs rm -rf || true
              
              # デプロイパッケージを削除
              rm -f deploy.tar.gz
              
              echo "✅ Deployment completed successfully"
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f deploy.tar.gz
