name: Deploy on VPS

on:
  repository_dispatch:
    types: [new-tag-created]
  # push:
  #   branches: [main]
  # workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: 'vps-deploy'
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.VPS_HOST }}
      USERNAME: ${{ secrets.VPS_USER }}
      PORT: ${{ secrets.VPS_SSH_PORT }}
      KEY: ${{ secrets.VPS_SSH_KEY }}
      APP_DIR: /var/www/talk-svelte
    steps:
      - name: Pull & Build on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: $HOST
          username: $USERNAME
          port: $PORT
          key: $KEY
          script: |
            set -e # Exit on error

            cd $APP_DIR

            git fetch origin --tags
            LATEST_TAG=$(git describe --tags --abbrev=0)
            echo "Deploying tag: $LATEST_TAG"
            git checkout tags/$LATEST_TAG

            npm ci
            NODE_ENV=production npm run build

            pm2 restart talk-svelte || pm2 start ecosystem.config.js

            echo "âœ… Deployment completed successfully"
